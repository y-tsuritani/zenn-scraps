---
title: "Workload Identity é€£æºã§ GitHub Actions ã‚’èªè¨¼ã™ã‚‹"
emoji: "ğŸš€"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["githubactions", "gcp", "workloadidentityfe"]
published: false
---

## ç›®çš„

GitHub Actions ã£ã¦ GitHub ãŒæä¾›ã™ã‚‹ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™ºã«ãŠã‘ã‚‹ãƒ“ãƒ«ãƒ‰ã€ãƒ†ã‚¹ãƒˆã€ãƒ‡ãƒ—ãƒ­ã‚¤ãªã©ã® CI/CD é–¢é€£ã‚’è‡ªå‹•åŒ–ã§ãã¦ä¾¿åˆ©ãã†ã§ã™ã‚ˆã­ã€‚
å½“ç„¶ã€GCP ã®ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã„ã¨ã„ã†ãƒ‹ãƒ¼ã‚ºãŒç”Ÿã¾ã‚Œã‚‹ã‚ã‘ã™ãŒã€ä»Šå›ã¯ãã®èªè¨¼ã«é–¢ã™ã‚‹è©±ã§ã™ã€‚

æœ€ã‚‚ä¸€èˆ¬çš„ãªæ–¹æ³•ã¨ã—ã¦ã¯ã€GitHub Actions ã«ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã‚’ç™ºè¡Œã—ã¦èªè¨¼ã‚’è¡Œã†ã‚ã‘ã§ã™ãŒã€ã‚ˆã‚Šã‚»ã‚­ãƒ¥ã‚¢ãªæ–¹æ³•ã¨ã—ã¦ ã€ŒWorkload Identity é€£æºã€ãŒæä¾›ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€è©¦ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

Workload Identity é€£æºã®è©³ã—ã„ã¨ã“ã‚ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

- [GitHub Actions ã‹ã‚‰ã®ã‚­ãƒ¼ãªã—ã®èªè¨¼ã®æœ‰åŠ¹åŒ–](https://cloud.google.com/blog/ja/products/identity-security/enabling-keyless-authentication-from-github-actions)

- [GitHub Actions: Secure cloud deployments with OpenID Connect](https://github.blog/changelog/2021-10-27-github-actions-secure-cloud-deployments-with-openid-connect/)

## æ¦‚è¦

GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ Workload Identity é€£æºã‚’ä½¿ç”¨ã—ã¦ GitHub Actions ã‹ã‚‰ Google Cloud ã«èªè¨¼ã‚’è¡Œã„ã¾ã™ã€‚

Workload Identity é€£æºã¯ã€GCP ãŒåˆ©ç”¨ã™ã‚‹èªè¨¼æ©Ÿæ§‹ã®ä¸€ç¨®ã§ã€ã“ã‚Œã‚’ä½¿ã†ã“ã¨ã«ã‚ˆã‚Šã€å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ GCP å†…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ã‚’å€Ÿç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

GitHub ã§ã¯ã€Workload Identity é€£æºã«å¯¾å¿œã™ã‚‹ ID ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’ç”¨æ„ã—ã¦ãŠã‚Šã€ã“ã®ãƒ—ãƒ­ãƒ‘ã‚¤ãƒ€ãŒèªè¨¼ã‚µãƒ¼ãƒã®å½¹å‰²ã‚’æœãŸã—ã¦ã„ã¾ã™ã€‚GCP ã§ã¯ã€GitHub ãŒç”¨æ„ã—ãŸ ID ãƒ—ãƒ­ãƒ‘ã‚¤ãƒ€ãŒæä¾›ã™ã‚‹èªè¨¼æƒ…å ±ã«å¿œã˜ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ã‚’ä¸ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚GitHub Actions ã¯ GitHub ãŒç”¨æ„ã—ãŸãƒ—ãƒ­ãƒ‘ã‚¤ãƒ€ã§èªè¨¼ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€GCP ã®ãƒªã‚½ãƒ¼ã‚¹ã«å¤‰æ›´ã‚’åŠ ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

çµæœã¨ã—ã¦ã€ã€Œ GCP ä»¥å¤–ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒæä¾›ã™ã‚‹å¤–éƒ¨ ID ã‚’ç”¨ã„ã¦ã€GCP ãƒªã‚½ãƒ¼ã‚¹ã«å¤‰æ›´ã‚’åŠ ãˆã‚‹ã€ã“ã¨ãŒã§ãã¾ã™ã€‚

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

![structure_img](img/2_GitHub_Actions.max-1100x1100.jpg)
GCP å…¬å¼ãƒ–ãƒ­ã‚°ã‚ˆã‚Šå¼•ç”¨

## æ§‹ç¯‰ã®æ‰‹é †

### äº‹å‰æº–å‚™

[GCP ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æº–å‚™ã™ã‚‹](https://cloud.google.com/iam/docs/configuring-workload-identity-federation?hl=ja#prepare_the_project)

ã€Œ GCP ä»¥å¤–ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒæä¾›ã™ã‚‹å¤–éƒ¨ ID ã‚’ç”¨ã„ã¦ã€GCP ãƒªã‚½ãƒ¼ã‚¹ã«å¤‰æ›´ã‚’åŠ ãˆã‚‹ã€ã“ã¨ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã¯ã€ã¾ãšäº‹å‰ã«å¤–éƒ¨ ID ã«å¯¾ã—ã¦ä¿¡é ¼ã™ã‚‹è¨­å®šã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã®ãŸã‚ã«ã¯ã€GCP å´ã§ä»¥ä¸‹ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

1. Workload Identity ãƒ—ãƒ¼ãƒ«
2. OIDC ID ãƒ—ãƒ­ãƒ‘ã‚¤ãƒ€

Workload Identity ãƒ—ãƒ¼ãƒ«ã«ã¯ã€è¤‡æ•°ã® OIDC ID ãƒ—ãƒ­ãƒ‘ã‚¤ãƒ€ãŒæ‰€å±ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã€ãƒ—ãƒ¼ãƒ«ã«å¯¾ã—ã¦ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å€Ÿç”¨ã™ã‚‹è¨±å¯ã‚’ä¸ãˆã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚OIDC ID ãƒ—ãƒ­ãƒ‘ã‚¤ãƒ€ã¯ã€ãã®åã®é€šã‚Šã€ID ãƒ—ãƒ­ãƒ‘ã‚¤ãƒ€ã«é–¢ã™ã‚‹æ¥ç¶šæƒ…å ±ãªã©ã‚’ã¾ã¨ã‚ãŸãƒªã‚½ãƒ¼ã‚¹ã§ã™ã€‚ä»Šå›ã§ã‚ã‚Œã°ï½¤ GitHub ãŒæä¾›ã—ã¦ã„ã‚‹ ID ãƒ—ãƒ­ãƒ‘ã‚¤ãƒ€ã‚’æŒ‡ã™ã“ã¨ã«ãªã‚Šã¾ã™ï½¡

ã“ã‚Œã‚‰ 2 ã¤ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ï½¤ Workload Identity é€£æºãŒå¯èƒ½ã«ãªã‚Šã¾ã™ï½¡

æ¬¡ã«ï½¤æ¨©é™ã®å€Ÿç”¨è¨±å¯ã‚’ä¸ãˆã‚‹æ¡ä»¶ã¨ã—ã¦ã€Œç‰¹å®šã®ãƒªãƒã‚¸ãƒˆãƒªã¸ã®ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã®ã¿ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æ¸¡ã—ãŸã„ã€ã¨ã„ã†æ¡ä»¶ã‚’è€ƒãˆã¾ã™ï½¡ã“ã®æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚‹éš›ã«ã®ã¿ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å€Ÿç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«ã€GitHub ã® ID ãƒ—ãƒ­ãƒ‘ã‚¤ãƒ€ãŒã©ã®ã‚ˆã†ãªå¿œç­”ã‚’ã™ã‚‹ã®ã‹ã€ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

### GCP ã®è¨­å®š: Workload Identity é€£æºã®è¨­å®š

GCP ã§ ID ãƒ—ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã™ï½¡ã€ŒIAM ã¨ç®¡ç†ã€> ã€ŒWorkload Identity é€£æºã€ã‚’é–‹ãï½¤ã€Œä½¿ã£ã¦ã¿ã‚‹ã€ã‚’é¸æŠã™ã‚‹ã¨ï½¤æ–°ã—ã„ãƒ—ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹ç”»é¢ã«ç§»è¡Œã—ã¾ã™ï½¡

ID ãƒ—ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹ãŸã‚ã«ã¯ï½¤åå‰ãŒå¿…è¦ãªã®ã§ï½¤é©å½“ã«æ±ºã‚ã¦å…¥åŠ›ã‚’è¡Œã„ã¾ã™ï½¡ ID ã‚‚å¿…è¦ã§ã™ãŒï½¤è‡ªå‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ãŸã‚ï½¤ã‚‚ã—å¤‰æ›´ã—ãŸã„å ´åˆã¯ç·¨é›†ã—ã¦ãã ã•ã„ï½¡

æ¬¡ã«ï½¤ID ãƒ—ãƒ¼ãƒ«ã«å¯¾ã—ã¦ï½¤GitHub ã® ID ãƒ—ãƒ­ãƒ‘ã‚¤ãƒ€ã‚’ç™»éŒ²ã—ã¾ã™ï½¡ç™ºè¡Œå…ƒã« `https://token.actions.githubusercontent.com` ã‚’æŒ‡å®šã™ã‚‹

ç™ºè¡Œã•ã‚ŒãŸ OIDC ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰ï½¤åˆ¤å®šã«åˆ©ç”¨ã™ã‚‹å±æ€§ã‚’ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã¾ã™ï½¡ ä»Šå›ã¯ï½¤ repository ã®å±æ€§ã«å…¥ã£ã¦ã„ã‚‹å€¤ã‚’ä½¿ã„ãŸã„ã“ã¨ï½¤ google.subject ã« sub ã®æƒ…å ±ã‚’æ¸¡ã™å¿…è¦ãŒã‚ã‚‹ãŸã‚ï½¤ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã¾ã™ï½¡

### GCP ã®è¨­å®š: å€Ÿç”¨ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®è¨­å®š

å€Ÿç”¨ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è¨­å®šã—ã¾ã™ï½¡ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆæ–¹æ³•ã«ã¤ã„ã¦ã¯ï½¤ã“ã®è¨˜äº‹ã§ã¯å‰²æ„›ã—ã¾ã™ï½¡
[ã‚µãƒ¼ãƒ“ã‚¹ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆã¨ç®¡ç†](https://cloud.google.com/iam/docs/creating-managing-service-accounts?hl=ja)

### GitHub Actions ã®ä½œæˆ

```yaml

```

## å‚è€ƒ

### å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

[GitHub Actions ã‹ã‚‰ã®ã‚­ãƒ¼ãªã—ã®èªè¨¼ã®æœ‰åŠ¹åŒ–](https://cloud.google.com/blog/ja/products/identity-security/enabling-keyless-authentication-from-github-actions)

[GitHub Actions: Secure cloud deployments with OpenID Connect](https://github.blog/changelog/2021-10-27-github-actions-secure-cloud-deployments-with-openid-connect/)

### API ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

#### Github Actions

- [Google Cloud Platform ã§ã® OpenID Connect ã®æ§‹æˆ](https://docs.github.com/ja/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-google-cloud-platform)

- [google-github-actions/auth](https://github.com/google-github-actions/auth)

- [ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ](https://docs.github.com/ja/actions/using-workflows/events-that-trigger-workflows#pull_request)

#### GCP

- [ID é€£æºã«ã‚ˆã‚Šæœ‰åŠ¹æœŸé–“ã®çŸ­ã„èªè¨¼æƒ…å ±ã‚’å–å¾—ã™ã‚‹](https://cloud.google.com/iam/docs/using-workload-identity-federation?hl=ja&_ga=2.233113054.-1968687333.1670507126&_gac=1.215256677.1676447449.CjwKCAiA_6yfBhBNEiwAkmXy5-xm9Vce3Abxvg4ukdplah0zhKcjf9r3wymvAflSQXCU6oks7vwFxBoCKtkQAvD_BwE#terraform)

- [Workload Identity ãƒ—ãƒ¼ãƒ«ã¨ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’ç®¡ç†ã™ã‚‹](https://cloud.google.com/iam/docs/manage-workload-identity-pools-providers?hl=ja)

- [ã‚µãƒ¼ãƒ“ã‚¹ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®æ¨©é™å€Ÿç”¨](https://cloud.google.com/iam/docs/workload-identity-federation?hl=ja#impersonation)

- [IAM permissions reference](https://cloud.google.com/iam/docs/permissions-reference)

### Architecture Documentation

### å‚è€ƒã«ã—ãŸè¨˜äº‹

- [GitHub Actions ã§ Terraform ã® CI/CD ã‚’æ§‹ç¯‰ã™ã‚‹](https://lab.mo-t.com/blog/terraform-github-actions)

- [ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã‚’ç”¨ã„ãšã« GitHub Actions ã‹ã‚‰ Google Cloud ã¨èªè¨¼ã™ã‚‹](https://dev.classmethod.jp/articles/google-cloud-auth-with-workload-identity/)

- [Workload Identity Federation ã‚’ GitHub Actions ã§åˆ©ç”¨ã™ã‚‹](https://zenn.dev/amazyra/articles/workloadidentityfederation)

- [Github Actions ã§ secret ã‚’ä½¿ã†](https://qiita.com/inouet/items/c7d39ac4641c05eec4a0)

- [GitHub Actions ã‚’ä½¿ã£ã¦ Google Cloud ç’°å¢ƒã« Terraform ã‚’å®Ÿè¡Œã™ã‚‹æ–¹æ³•](https://blog.g-gen.co.jp/entry/using-terraform-via-github-actions)

- [Workload Identity Federation ã‚’å›³ã§ç†è§£ã™ã‚‹](https://christina04.hatenablog.com/entry/workload-identity-federation)

- [github-script ã¯ä¾¿åˆ©ã§ã™](https://qiita.com/bugfire/items/a2fa85fa58dd20322e3f)
